!function(a){var b=Array.prototype;a.newPlugin=function(c,d,e,f){function g(b,e){this.opts=a.extend({},d,e),this.el=b,this._name=c,this._init()}g.prototype._init=a.noop,g.prototype[c]=function(a){if(!a)return this;try{return this[a].apply(this,b.slice.call(arguments,1))}catch(c){}},a.extend(g.prototype,e),f&&(a[c]=f),a.fn[c]=function(){var d,e=b.slice.call(arguments),f="string"==typeof e[0]&&e[0].split(":"),h="object"==typeof e[0]&&e[0],i=e.slice(1),j="get"==f[0];return this.each(function(){var b=a.data(this,c);return b?d=b[c].apply(b,[f[+j]].concat(i)):a.data(this,c,new g(this,h))}),j?d:this}}}(jQuery),DTFINDER={},DTFINDER.config={data:{},classes:{},permissions:{}},DTFINDER.DOM={create:function(a,b){var c=document.createElement(a);return"undefined"!=typeof b&&$.each(b,function(a,b){$(c).attr(a,b)}),$(c)},createToolbar:function(){var a=this.create("DIV").addClass("row dtf-toolbar");if(DTFINDER.config.permissions.create){var b=this.create("A",{href:"#","data-toggle":"modal","data-target":"#upload-dialog"}).addClass("upload-btn tool btn btn-sm btn-success pull-left").html('<i class="fa fa-upload"></i> Upload');$(a).append(b)}var c=this.create("FORM").addClass("form-inline"),d=this.create("INPUT",{type:"text",name:"q",placeholder:"Search"}).addClass("input-sm form-control pull-right dt-search-input");return $(c).append(d),$(a).append(c),a},createUploadDialog:function(a){var b=['<form method="POST" enctype="multipart/form-data" class="form clearfix" id="upload-form" action="'+a+'">','<input multiple type="file" name="files[]" style="margin-bottom:10px;">','<div class="uploaded"></div>','<input type="submit" class="btn btn-primary btn-sm pull-right" value="Submit">','<a href="javascript:;" class="btn btn-default btn-sm pull-right" data-dismiss="modal" style="margin-right:10px;">Cancel</a>',"</form>"].join("");return this.createModal("upload-dialog",b)},createNewFolderDialog:function(a){var b=['<form method="GET" class="form clearfix" id="new-folder-form" action="'+a+'">','<label class="control-label">Folder Name</label>','<input type="text" name="folder-name" value="New Folder" class="form-control new-folder-input" style="margin-bottom:10px;"/>','<input type="submit" class="btn btn-sm btn-primary pull-right" value="Submit"/>','<a href="#" style="margin-right:10px;" class="btn btn-sm btn-default pull-right" data-dismiss="modal">Cancel</a>',"</form>"].join("");return this.createModal("new-folder-dialog",b,"modal-sm")},createSubBrowserDialog:function(){var a='<div><button class="btn btn-xs pull-right btn-primary folder-selector">Select</button></div>';return this.createModal("sub-browser-dialog",a,"modal-sm")},createPropertiesDialog:function(){var a="";return this.createModal("properties-dialog",a,"modal-sm")},createModal:function(a,b,c){var c=c||"",d=this.create("DIV",{id:a}).addClass("modal"),e=this.create("DIV").addClass("modal-body"),f=this.create("DIV").addClass("modal-dialog "+c),g=this.create("DIV").addClass("modal-content");return $(e).html(b),$(g).append(e),$(f).append(g),$(d).append(f),d},createBrowserContext:function(){var a={};return DTFINDER.config.permissions.create&&(a["new-folder"]="New Folder…"),a.properties="Properties",this.createContextMenu("bro-context-menu",a)},createItemContext:function(){var a={};return DTFINDER.config.permissions.move&&(a.rename="Rename",a.move="Move…"),DTFINDER.config.permissions["delete"]&&(a["delete"]="Delete…"),a.properties="Properties",this.createContextMenu("item-context-menu",a)},createContextMenu:function(a,b){var c=this.create("UL",{role:"menu"}).addClass("dropdown-menu");$.each(b,$.proxy(function(a,b){var d=this.createContextAction(a,b);$(c).append(d)},this));var d=this.create("DIV",{id:a}).append(c);return d},createContextAction:function(a,b){var c=this.create("A",{href:"#"}).text(b),d=this.create("LI",{"data-action":a}).append(c);return d},createFileItem:function(a){var b=this.create("LI").addClass("dtf-file-item dtf-context-holder");if(b.data("context-target","#item-context-menu"),"image"==a.type){var c=this.create("IMG",{src:a.base64}).addClass("icon");$(b).addClass("img-item")}else{if("file"==a.type){var d="fa fa-file-o";$(b).addClass("file-item")}else if("dir"==a.type){var d="fa fa-folder-o";$(b).addClass("folder-item")}else var d=null;var c=this.create("I").addClass("icon").addClass(d)}var e=this.create("A",{href:a.path}).append(c).append('<div style="overflow: hidden;text-overflow: ellipsis;" class="file-name">'+a.label+"</div>");return $(b).append(e),b}},function(a){var b,c,d,e;b="dttree",c={initData:[],classes:{collapsedToggler:"fa fa-folder-o",expandedToggler:"fa fa-folder-open-o"}},d={_init:function(){this.$el=a(this.el);var b=this._buildList(this.opts.initData);a(this.el).append(b),this._listen()},_listen:function(){var b=this;a(this.el).on("click","a.dttree-node-toggler",function(c){c.preventDefault();var d=a(this).siblings(".dttree-node"),e=d.attr("href");a(this).children("i").hasClass(b.opts.classes.expandedToggler)?b.collapse(e):b.expand(e)})},_buildList:function(b){if(b.length>0){var c=this._create("UL");for(i=0;i<b.length;i++)if("dir"===b[i].type){var d=this._createNode(b[i].path,b[i].label);a(c).append(d)}return c}return null},_createNode:function(a,b){var c=this._create("I").addClass(this.opts.classes.collapsedToggler);a="/"===a?"":a;var d=this._create("A",{href:"#/"+a}).addClass("dttree-node").append(" "+b),e=this._create("A",{href:"#"}).addClass("dttree-node-toggler").append(c),f=this._create("LI").append(e).append(d);return f},_create:function(b,c){var d=document.createElement(b);return"undefined"!=typeof c&&a.each(c,function(b,c){a(d).attr(b,c)}),a(d)},setChildren:function(b,c){if("undefined"==typeof c)var d=this.element;else var e=a('a[href="#'+c+'"].dttree-node',this.el),d=e.parent("li");d.children("ul").remove();var f=this._buildList(b);a(f).hide(),d.append(f)},collapse:function(b){b=this._sanitizePath(b);var c=a('a[href="'+b+'"]',this.el),d=a(c).siblings(".dttree-node-toggler").children("i");d.removeClass(this.opts.classes.expandedToggler),d.addClass(this.opts.classes.collapsedToggler),a(c).siblings("ul").slideUp("fast")},expand:function(b){b=this._sanitizePath(b);var c=a('a[href="'+b+'"]',this.el);a.isFunction(this.opts.onBeforeExpand)&&this.opts.onBeforeExpand(b,this);var d=a(c).siblings(".dttree-node-toggler").children("i");d.removeClass(this.opts.classes.collapsedToggler),d.addClass(this.opts.classes.expandedToggler),a(c).siblings("ul").slideDown("fast")},_sanitizePath:function(a){return"#"==a[0]?a:"#"+a}},e={},a.newPlugin(b,c,d,e)}(jQuery,window,document),DTFINDER.File={url:null,data:{},list:function(a){var b={op:"ls",path:a};return this._sendRequest("GET",b,!0)},move:function(a,b){var c={op:"move",path:a,dest:b};return this._sendRequest("POST",c)},rename:function(a,b){var c={op:"rename",path:a,newName:b};return this._sendRequest("POST",c)},"delete":function(a){var b={op:"delete",path:a};return this._sendRequest("POST",b,!0)},properties:function(a){var b={op:"properties",path:a};return this._sendRequest("GET",b,!0)},search:function(a,b){var c={op:"search",path:b,q:a};return this._sendRequest("GET",c,!0)},_sendRequest:function(a,b,c){b=$.extend(b,this.data);var d=$.ajax({url:this.url,data:b,type:a,async:!1});if("undefined"!=typeof c&&c===!0){var e;return d.done(function(a){e=a}),e}}},function(a){var b,c,d,e;b="dtfinder",c={url:null,manage:!0,upload:!0,uploadUrl:null,width:"100%",height:600,onSelect:!1,permissions:{create:!0,"delete":!0,move:!0},data:{}},d={_init:function(){DTFINDER.config=this.opts,DTFINDER.config.data=a.extend({},c.data,this.opts.data),DTFINDER.config.permissions=a.extend({},c.permissions,this.opts.permissions),this._caches={},this._caches.loaded=[],this._caches.data=[],DTFINDER.File.url=this.opts.url,DTFINDER.File.data=this.opts.data,this.createElements(this.el,this.opts),this.initTree(),this.listen(this.el,this.opts),this.openRoot()},initTree:function(){var b=[{path:"/",label:"/",type:"dir"}],c=this;this.nav.dttree({initData:b,onBeforeExpand:function(b,d){if(b=b.substr(1),-1===a.inArray(b,c._caches.loaded)){var e=DTFINDER.File.list(b);c._caches.data[b]=e,c._caches.loaded.push(b)}d.setChildren(c._caches.data[b],b),c.handleHight()}})},openRoot:function(){var b=window.location.hash.substr(1);if(b)for(var c=b.split("/"),d="",e="/";0!==c.length;)d=d+c.shift()+"/",d.trim(),"/"!=d&&(e=d.substr(0,d.length-1)),this.nav.dttree("expand",e);else{b="/",window.location.hash="/";{a('a[href="#'+b+'"]')}this.nav.dttree("expand",b)}this.open(b)},listen:function(b,c){var d=this;window.onpopstate=function(){var a=window.location.hash.substr(1);d.open(a)},a("#sub-browser-dialog").on("click","a.dttree-node",function(b){b.preventDefault();var c=b.currentTarget;a("#sub-browser-dialog").find(".selected").removeClass("selected"),a(c).addClass("selected")}),c.manage&&this.listenContextMenu(b),this.listenUpload(this._caches.currentPath),this.listenCreateFolder(this._caches.currentPath),this.listenRename(),this.listenSearch(),a(b).on("click",".dtf-file-item a",function(a){a.preventDefault()}),a(b).on("click",".img-item a",function(b){b.preventDefault(),a.isFunction(c.onISelect)&&c.onISelect(b)})},open:function(b){if(this._caches.currentPath=b,-1===a.inArray(b,this._caches.loaded)){var c=DTFINDER.File.list(b);this._caches.data[b]=c,this._caches.loaded.push(b)}this.listenUpload(b),this.listenCreateFolder(b),this.updateBrowser(this._caches.data[b]),this.handleHight()},listenSearch:function(){var b=this;a(document).on("keyup",".dt-search-input",function(){var c=a(this).val();if(c.length>1){var d=b._caches.currentPath,e=DTFINDER.File.search(c,d);b.updateBrowser(e)}})},listenRename:function(){var b=13,c=27,d=this;a(document).on("keyup",".dt-rename-input",function(e){if((e.keyCode==c||e.which==c)&&(a(e.target).parent().siblings("a").children(".file-name").show(),a(e.target).parent().remove()),e.keyCode==b||e.which==b){var f=a(this).data("path"),g=a(this).val();DTFINDER.File.rename(f,g),a(e.target).parent().siblings("a").children(".file-name").text(g).show(),a(e.target).parent().remove(),d.refresh()}}),a(document).on("blur",".dt-rename-input",function(b){a(b.target).parent().siblings("a").children(".file-name").show(),a(b.target).parent().remove()})},listenContextMenu:function(b){a(b).contextmenu({onItem:a.proxy(this.handleContext,this),before:function(c){var d=null;if(a(c.target).hasClass("dtf-context-holder"))a(b).data("context-holder",c.target),d=a(c.target).data("context-target");else{var e=a(c.target).parents();a.each(e,function(c,e){return a(e).hasClass("dtf-context-holder")?(a(b).data("context-holder",e),d=a(e).data("context-target"),!1):void 0})}return null===d?!1:(a(b).data("target",d),!0)}})},listenUpload:function(b){var c=a.extend({path:b,op:"upload"},this.opts.data);a("#upload-form").ajaxForm({data:c,success:a.proxy(function(c){this.refresh(b);for(var d=0;d<c.length;d++)a(".uploaded").append("<p> New file: "+c[d].uploaded+"</p>")},this)})},listenCreateFolder:function(b){var c=a.extend({path:b,op:"mkdir"},this.opts.data);a("#new-folder-form").ajaxForm({data:c,success:a.proxy(function(){this.refresh(b),a("#new-folder-dialog").modal("hide")},this)})},handleHight:function(){var b=a(".dtf-area").height();a(".dtf-nav").height(b)},handleContext:function(b,c){c.preventDefault();var d=a(c.target).parent().data("action"),e=a(b).data("context-holder"),f=a(e).children("a").attr("href");switch(d){case"delete":if(!confirm("Are you sure you want to delete "+f+" ?, this cannot be undone."))return!1;{DTFINDER.File["delete"](f)}this.refresh();break;case"rename":var g=a(e).find(".file-name"),h=g.text();g.hide(),a(e).append('<div><input data-path="'+f+'" type="text" style="height:18px;" class="form-control input-sm dt-rename-input" value="'+h+'"></div>'),a(e).find(".dt-rename-input").select();break;case"new-folder":return a("#new-folder-dialog").on("shown.bs.modal",function(){a(".new-folder-input").select()}),void a("#new-folder-dialog").modal("show");case"move":a("#sub-browser-dialog .modal-body").dttree({initData:[{path:"/",label:"/",type:"dir"}],onBeforeExpand:function(a,b){a=a.substr(1);var c=DTFINDER.File.list(a);b.setChildren(c,a)}});var i=this;a("#sub-browser-dialog").on("click",".folder-selector",function(){var b=a("#sub-browser-dialog").find(".selected").attr("href").substr(1);DTFINDER.File.move(f,b),i.refresh(),a("#sub-browser-dialog").modal("hide")}),a("#sub-browser-dialog").modal("show");break;case"properties":f||(f=this._caches.currentPath);var h=DTFINDER.File.properties(f),j=["<table>",'<tr><td class="property-label" valign="top" width="70px;">Name</td><td>'+h.Name+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Type</td><td>'+h.Type+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Size</td><td>'+h.Size+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Location</td><td>'+h.Location+"</td></tr>","</table>"].join("");a("#properties-dialog").on("shown.bs.modal",function(){a(this).find(".modal-body").html(j)}),a("#properties-dialog").modal("show")}},updateBrowser:function(b){for(var c=DTFINDER.DOM.create("UL"),d=0;d<b.length;d++){var e=DTFINDER.DOM.createFileItem(b[d]);a(c).append(e)}a(this.browserArea).html(c)},refresh:function(a){"undefined"==typeof a&&(a=this._caches.currentPath),data=DTFINDER.File.list("/"+a),this._caches.data[a]=data,this.updateBrowser(data);for(var b=this._caches.loaded.length-1;b--;)this._caches.loaded[b].trim()==a.trim()&&this._caches.loaded.splice(b,1);this._caches.loaded=[],this.nav.dttree("expand",a)},createElements:function(b,c){this.nav=a("<div/>").addClass("dtf-nav ctn"),this.browserArea=a("<div/>").addClass("dtf-area ctn dtf-context-holder").data("context-target","#bro-context-menu");var d=a("<div/>").addClass("row"),e=a("<div/>").addClass("wrapper container-fluid"),f=DTFINDER.DOM.createToolbar(),g=this.opts.uploadUrl||this.opts.url,h=DTFINDER.DOM.createUploadDialog(g),i=this.opts.createFolderUrl||this.opts.url,j=DTFINDER.DOM.createNewFolderDialog(i),k=DTFINDER.DOM.createSubBrowserDialog(),l=DTFINDER.DOM.createPropertiesDialog(),m=DTFINDER.DOM.createItemContext(),n=DTFINDER.DOM.createBrowserContext();a(d).append(this.nav).append(this.browserArea),a(e).append(f).append(d),a(b).width(c.width).append(e).after(m).after(n).after(h).after(j).after(k).after(l)}},e={},a.newPlugin(b,c,d,e)}(jQuery,window,document);