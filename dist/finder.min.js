DTFINDER={},DTFINDER.config={data:{},classes:{},permissions:{}},DTFINDER.DOM={create:function(a,b){return el=document.createElement(a),"undefined"!=typeof b&&$.each(b,function(a,b){$(el).attr(a,b)}),$(el)},createToolbar:function(){var a=this.create("DIV").addClass("row dtf-toolbar");if(DTFINDER.config.permissions.create){var b=this.create("A",{href:"#","data-toggle":"modal","data-target":"#upload-dialog"}).addClass("upload-btn tool btn btn-sm btn-success pull-left").html('<i class="fa fa-upload"></i> Upload');$(a).append(b)}var c=this.create("FORM").addClass("form-inline"),d=this.create("INPUT",{type:"text",name:"q",placeholder:"Search"}).addClass("input-sm form-control pull-right dt-search-input");return $(c).append(d),$(a).append(c),a},createUploadDialog:function(a){var b=['<form method="POST" enctype="multipart/form-data" class="form clearfix" id="upload-form" action="'+a+'">','<input multiple type="file" name="files[]" style="margin-bottom:10px;">','<div class="uploaded"></div>','<input type="submit" class="btn btn-primary btn-sm pull-right" value="Submit">','<a href="javascript:;" class="btn btn-default btn-sm pull-right" data-dismiss="modal" style="margin-right:10px;">Cancel</a>',"</form>"].join("");return this.createModal("upload-dialog",b)},createNewFolderDialog:function(a){var b=['<form method="GET" class="form clearfix" id="new-folder-form" action="'+a+'">','<label class="control-label">Folder Name</label>','<input type="text" name="folder-name" value="New Folder" class="form-control new-folder-input" style="margin-bottom:10px;"/>','<input type="submit" class="btn btn-sm btn-primary pull-right" value="Submit"/>','<a href="#" style="margin-right:10px;" class="btn btn-sm btn-default pull-right" data-dismiss="modal">Cancel</a>',"</form>"].join("");return this.createModal("new-folder-dialog",b,"modal-sm")},createSubBrowserDialog:function(){var a='<div><button class="btn btn-xs pull-right btn-primary folder-selector">Select</button></div>';return this.createModal("sub-browser-dialog",a,"modal-sm")},createPropertiesDialog:function(){var a="";return this.createModal("properties-dialog",a,"modal-sm")},createModal:function(a,b,c){var c=c||"",d=this.create("DIV",{id:a}).addClass("modal"),e=this.create("DIV").addClass("modal-body"),f=this.create("DIV").addClass("modal-dialog "+c),g=this.create("DIV").addClass("modal-content");return $(e).html(b),$(g).append(e),$(f).append(g),$(d).append(f),d},createBrowserContext:function(){var a={};return DTFINDER.config.permissions.create&&(a["new-folder"]="New Folder…"),a.properties="Properties",this.createContextMenu("bro-context-menu",a)},createItemContext:function(){var a={};return DTFINDER.config.permissions.move&&(a.rename="Rename",a.move="Move…"),DTFINDER.config.permissions["delete"]&&(a["delete"]="Delete…"),a.properties="Properties",this.createContextMenu("item-context-menu",a)},createContextMenu:function(a,b){var c=this.create("UL",{role:"menu"}).addClass("dropdown-menu");$.each(b,$.proxy(function(a,b){li=this.createContextAction(a,b),$(c).append(li)},this));var d=this.create("DIV",{id:a}).append(c);return d},createContextAction:function(b,c){return a=this.create("A",{href:"#"}).text(c),li=this.create("LI",{"data-action":b}).append(a),li},createNode:function(a,b){var c=this.create("I").addClass(DTFINDER.config.classes.collapse);a="/"===a?"":a;var d=this.create("A",{href:"#/"+a}).addClass("dtf-tree-node").append(" "+b),e=this.create("A",{href:"#"}).addClass("toggler").append(c),f=this.create("LI").append(e).append(d);return f},createFileItem:function(a){var b=this.create("LI").addClass("dtf-file-item dtf-context-holder");if(b.data("context-target","#item-context-menu"),"image"==a.type){var c=this.create("IMG",{src:a.base64}).addClass("icon");$(b).addClass("img-item")}else{if("file"==a.type){var d="fa fa-file-o";$(b).addClass("file-item")}else if("dir"==a.type){var d="fa fa-folder-o";$(b).addClass("folder-item")}else var d=null;var c=this.create("I").addClass("icon").addClass(d)}var e=this.create("A",{href:a.path}).append(c).append('<div style="overflow: hidden;text-overflow: ellipsis;" class="file-name">'+a.label+"</div>");return $(b).append(e),b}},function(a){var b=Array.prototype;a.newPlugin=function(c,d,e,f){function g(b,e){this.opts=a.extend({},d,e),this.el=b,this._name=c,this._init()}g.prototype._init=a.noop,g.prototype[c]=function(a){if(!a)return this;try{return this[a].apply(this,b.slice.call(arguments,1))}catch(c){}},a.extend(g.prototype,e),f&&(a[c]=f),a.fn[c]=function(){var d,e=b.slice.call(arguments),f="string"==typeof e[0]&&e[0].split(":"),h="object"==typeof e[0]&&e[0],i=e.slice(1),j="get"==f[0];return this.each(function(){var b=a.data(this,c);return b?d=b[c].apply(b,[f[+j]].concat(i)):a.data(this,c,new g(this,h))}),j?d:this}}}(jQuery),function(a){var b,c,d,e;b="dttree",c={initData:[],classes:{collapsedToggler:"fa fa-folder-o",expandedToggler:"fa fa-folder-open-o"}},d={_init:function(){this.$el=a(this.el);var b=this._buildList(this.opts.initData);a(this.el).append(b),this._listen()},_listen:function(){var b=this;a(this.el).on("click","a.dttree-node-toggler",function(c){c.preventDefault();var d=a(this).siblings(".dttree-node"),e=d.attr("href");a(this).children("i").hasClass(b.opts.classes.expandedToggler)?b.collapse(e):b.expand(e)})},_buildList:function(b){if(b.length>0){var c=this._create("UL");for(i=0;i<b.length;i++)if("dir"===b[i].type){var d=this._createNode(b[i].path,b[i].label);a(c).append(d)}return c}return null},_createNode:function(a,b){var c=this._create("I").addClass(this.opts.classes.collapsedToggler);a="/"===a?"":a;var d=this._create("A",{href:"#/"+a}).addClass("dttree-node").append(" "+b),e=this._create("A",{href:"#"}).addClass("dttree-node-toggler").append(c),f=this._create("LI").append(e).append(d);return f},_create:function(b,c){var d=document.createElement(b);return"undefined"!=typeof c&&a.each(c,function(b,c){a(d).attr(b,c)}),a(d)},setChildren:function(b,c){if("undefined"==typeof c)var d=this.element;else var e=a('a[href="#'+c+'"].dttree-node',this.el),d=e.parent("li");d.children("ul").remove();var f=this._buildList(b);a(f).hide(),d.append(f)},collapse:function(b){b=this._sanitizePath(b);var c=a('a[href="'+b+'"]',this.el),d=a(c).siblings(".dttree-node-toggler").children("i");d.removeClass(this.opts.classes.expandedToggler),d.addClass(this.opts.classes.collapsedToggler),a(c).siblings("ul").slideUp("fast")},expand:function(b){b=this._sanitizePath(b);var c=a('a[href="'+b+'"]',this.el);a.isFunction(this.opts.onBeforeExpand)&&this.opts.onBeforeExpand(b,this);var d=a(c).siblings(".dttree-node-toggler").children("i");d.removeClass(this.opts.classes.collapsedToggler),d.addClass(this.opts.classes.expandedToggler),a(c).siblings("ul").slideDown("fast")},_sanitizePath:function(a){return"#"==a[0]?a:"#"+a}},e={},a.newPlugin(b,c,d,e)}(jQuery,window,document),DTFINDER.File={url:null,data:{},list:function(a){var b,c=$.extend({op:"ls",path:a},this.data);return $.ajax({url:this.url,data:c,async:!1}).done(function(a){b=a}),b},move:function(a,b){var c=$.extend({op:"move",path:a,dest:b},this.data);$.ajax({url:this.url,type:"POST",data:c,async:!1})},rename:function(a,b){var c=$.extend({op:"rename",path:a,newName:b},this.data);$.ajax({url:this.url,type:"POST",data:c,async:!1})},"delete":function(a){var b,c=$.extend({op:"delete",path:a},this.data);return $.ajax({url:this.url,data:c,async:!1}).done(function(a){b=a}),b},properties:function(a){var b,c=$.extend({op:"properties",path:a},this.data);return $.ajax({url:this.url,data:c,async:!1}).done(function(a){b=a}),b},search:function(a,b){var c,d=$.extend({op:"search",path:b,q:a},this.data);return $.ajax({url:this.url,data:d,async:!1}).done(function(a){c=a}),c}},function(a,b,c,d){function e(b,c){this.element=b,this.options=d.config=a.extend({},g,c),this.options.data=d.config.data=a.extend({},g.data,c.data),this.options.classes=d.config.classes=a.extend({},g.classes,c.classes),this.options.permissions=d.config.permissions=a.extend({},g.permissions,c.permissions),this._defaults=g,this._name=f,this.init()}var f="dtfinder",g={url:null,manage:!0,upload:!0,uploadUrl:null,width:"100%",height:600,onSelect:!1,classes:{collapse:"fa fa-folder-o",expand:"fa fa-folder-open-o"},permissions:{create:!0,"delete":!0,move:!0},data:{}};e.prototype={init:function(){this._caches={},this._caches.loaded=[],this._caches.data=[],d.File.url=this.options.url,d.File.data=this.options.data,this.createElements(this.element,this.options),this.initTree(),this.listen(this.element,this.options),this.openRoot()},initTree:function(){var b=[{path:"/",label:"/",type:"dir"}],c=this;this.nav.dttree({initData:b,onBeforeExpand:function(b,e){if(b=b.substr(1),-1===a.inArray(b,c._caches.loaded)){var f=d.File.list(b);c._caches.data[b]=f,c._caches.loaded.push(b)}e.setChildren(c._caches.data[b],b),c.handleHight()}})},openRoot:function(){var c=b.location.hash.substr(1);if(c)for(var d=c.split("/"),e="",f="/";0!==d.length;)e=e+d.shift()+"/",e.trim(),"/"!=e&&(f=e.substr(0,e.length-1)),this.nav.dttree("expand","#"+f);else{c="/",b.location.hash="/";{a('a[href="#'+c+'"]')}this.nav.dttree("expand",c)}this.open(c)},listen:function(c,d){var e=this;b.onpopstate=function(){var a=b.location.hash.substr(1);e.open(a)},a("#sub-browser-dialog").on("click","a.dttree-node",function(b){b.preventDefault();var c=b.currentTarget;a("#sub-browser-dialog").find(".selected").removeClass("selected"),a(c).addClass("selected")}),d.manage&&this.listenContextMenu(c),this.listenUpload(this._caches.currentPath),this.listenCreateFolder(this._caches.currentPath),this.listenRename(),this.listenSearch(),a(c).on("click",".dtf-file-item a",function(a){a.preventDefault()}),a(c).on("click",".img-item a",function(b){b.preventDefault(),a.isFunction(d.onISelect)&&d.onISelect(b)})},open:function(b){if(this._caches.currentPath=b,-1===a.inArray(b,this._caches.loaded)){var c=d.File.list(b);this._caches.data[b]=c,this._caches.loaded.push(b)}this.listenUpload(b),this.listenCreateFolder(b),this.updateBrowser(this._caches.data[b]),this.handleHight()},listenSearch:function(){var b=this;a(c).on("keyup",".dt-search-input",function(){var c=a(this).val();if(c.length>1){var e=b._caches.currentPath,f=d.File.search(c,e);b.updateBrowser(f)}})},listenRename:function(){var b=13,e=27,f=this;a(c).on("keyup",".dt-rename-input",function(c){if((c.keyCode==e||c.which==e)&&(a(c.target).parent().siblings("a").children(".file-name").show(),a(c.target).parent().remove()),c.keyCode==b||c.which==b){var g=a(this).data("path"),h=a(this).val();d.File.rename(g,h),a(c.target).parent().siblings("a").children(".file-name").text(h).show(),a(c.target).parent().remove(),f.refresh()}}),a(c).on("blur",".dt-rename-input",function(b){a(b.target).parent().siblings("a").children(".file-name").show(),a(b.target).parent().remove()})},listenContextMenu:function(b){a(b).contextmenu({onItem:a.proxy(this.handleContext,this),before:function(c){var d=null;if(a(c.target).hasClass("dtf-context-holder"))a(b).data("context-holder",c.target),d=a(c.target).data("context-target");else{var e=a(c.target).parents();a.each(e,function(c,e){return a(e).hasClass("dtf-context-holder")?(a(b).data("context-holder",e),d=a(e).data("context-target"),!1):void 0})}return null===d?!1:(a(b).data("target",d),!0)}})},listenUpload:function(b){var c=a.extend({path:b,op:"upload"},this.options.data);a("#upload-form").ajaxForm({data:c,success:a.proxy(function(c){for(this.refresh(b),i=0;i<c.length;i++)a(".uploaded").append("<p> New file: "+c[i].uploaded+"</p>")},this)})},listenCreateFolder:function(b){var c=a.extend({path:b,op:"mkdir"},this.options.data);a("#new-folder-form").ajaxForm({data:c,success:a.proxy(function(){this.refresh(b),a("#new-folder-dialog").modal("hide")},this)})},handleHight:function(){var b=a(".dtf-area").height();a(".dtf-nav").height(b)},handleContext:function(b,c){c.preventDefault();var e=a(c.target).parent().data("action"),f=a(b).data("context-holder"),g=a(f).children("a").attr("href");switch(e){case"delete":if(!confirm("Are you sure you want to delete "+g+" ?, this cannot be undone."))return!1;{d.File["delete"](g)}this.refresh();break;case"rename":var h=a(f).find(".file-name"),i=h.text();h.hide(),a(f).append('<div><input data-path="'+g+'" type="text" style="height:18px;" class="form-control input-sm dt-rename-input" value="'+i+'"></div>'),a(f).find(".dt-rename-input").select();break;case"new-folder":return a("#new-folder-dialog").on("shown.bs.modal",function(){a(".new-folder-input").select()}),void a("#new-folder-dialog").modal("show");case"move":a("#sub-browser-dialog .modal-body").dttree({initData:[{path:"/",label:"/",type:"dir"}],onBeforeExpand:function(a,b){a=a.substr(1);var c=d.File.list(a);b.setChildren(c,a)}});var j=this;a("#sub-browser-dialog").on("click",".folder-selector",function(){var b=a("#sub-browser-dialog").find(".selected").attr("href").substr(1);d.File.move(g,b),j.refresh(),a("#sub-browser-dialog").modal("hide")}),a("#sub-browser-dialog").modal("show");break;case"properties":g||(g=this._caches.currentPath);var i=d.File.properties(g),k=["<table>",'<tr><td class="property-label" valign="top" width="70px;">Name</td><td>'+i.Name+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Type</td><td>'+i.Type+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Size</td><td>'+i.Size+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Location</td><td>'+i.Location+"</td></tr>","</table>"].join("");a("#properties-dialog").on("shown.bs.modal",function(){a(this).find(".modal-body").html(k)}),a("#properties-dialog").modal("show")}},updateBrowser:function(b){for(ul=d.DOM.create("UL"),i=0;i<b.length;i++){var c=d.DOM.createFileItem(b[i]);a(ul).append(c)}a(this.browserArea).html(ul)},refresh:function(b){"undefined"==typeof b&&(b=this._caches.currentPath),data=d.File.list("/"+b),this._caches.data[b]=data,this.updateBrowser(data);for(var c=this._caches.loaded.length-1;c--;)this._caches.loaded[c].trim()==b.trim()&&this._caches.loaded.splice(c,1);this._caches.loaded=[];var e=a('a[href="'+b+'"]');e.siblings("ul").remove(),e.children("i").hasClass(this.options.classes.expand)&&(e.click(),e.click())},createElements:function(b,c){this.nav=d.DOM.create("DIV").addClass("dtf-nav ctn"),this.browserArea=d.DOM.create("DIV").addClass("dtf-area ctn dtf-context-holder"),a(this.browserArea).data("context-target","#bro-context-menu");var e=d.DOM.create("DIV").addClass("row"),f=d.DOM.create("DIV").addClass("wrapper container-fluid"),g=d.DOM.createToolbar(),h=this.options.uploadUrl||this.options.url,i=d.DOM.createUploadDialog(h),j=this.options.createFolderUrl||this.options.url,k=d.DOM.createNewFolderDialog(j),l=d.DOM.createSubBrowserDialog(),m=d.DOM.createPropertiesDialog(),n=d.DOM.createItemContext(),o=d.DOM.createBrowserContext();a(e).append(this.nav).append(this.browserArea),a(f).append(g).append(e),a(b).width(c.width).append(f).after(n).after(o).after(i).after(k).after(l).after(m)}},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document,DTFINDER);