DTFINDER={},DTFINDER.config={data:{},classes:{},permissions:{}},DTFINDER.DOM={create:function(a,b){return el=document.createElement(a),"undefined"!=typeof b&&$.each(b,function(a,b){$(el).attr(a,b)}),$(el)},createToolbar:function(){var a=this.create("DIV").addClass("row dtf-toolbar");if(DTFINDER.config.permissions.create){var b=this.create("A",{href:"#","data-toggle":"modal","data-target":"#upload-dialog"}).addClass("upload-btn tool btn btn-sm btn-success pull-left").html('<i class="fa fa-upload"></i> Upload');$(a).append(b)}var c=this.create("FORM").addClass("form-inline"),d=this.create("INPUT",{type:"text",name:"q",placeholder:"Type to search"}).addClass("input-sm form-control pull-right dt-search-input");return $(c).append(d),$(a).append(c),a},createUploadDialog:function(a){var b=['<form method="POST" enctype="multipart/form-data" class="form clearfix" id="upload-form" action="'+a+'">','<input multiple type="file" name="files[]" style="margin-bottom:10px;">','<div class="uploaded"></div>','<input type="submit" class="btn btn-primary btn-sm pull-right" value="Submit">','<a href="javascript:;" class="btn btn-default btn-sm pull-right" data-dismiss="modal" style="margin-right:10px;">Cancel</a>',"</form>"].join("");return this.createModal("upload-dialog",b)},createNewFolderDialog:function(a){var b=['<form method="GET" class="form clearfix" id="new-folder-form" action="'+a+'">','<label class="control-label">Folder Name</label>','<input type="text" name="folder-name" value="New Folder" class="form-control new-folder-input" style="margin-bottom:10px;"/>','<input type="submit" class="btn btn-sm btn-primary pull-right" value="Submit"/>','<a href="#" style="margin-right:10px;" class="btn btn-sm btn-default pull-right" data-dismiss="modal">Cancel</a>',"</form>"].join("");return this.createModal("new-folder-dialog",b,"modal-sm")},createSubBrowserDialog:function(){var a="";return this.createModal("sub-browser-dialog",a,"modal-sm")},createPropertiesDialog:function(){var a="";return this.createModal("properties-dialog",a,"modal-sm")},createModal:function(a,b,c){var c=c||"",d=this.create("DIV",{id:a}).addClass("modal"),e=this.create("DIV").addClass("modal-body"),f=this.create("DIV").addClass("modal-dialog "+c),g=this.create("DIV").addClass("modal-content");return $(e).html(b),$(g).append(e),$(f).append(g),$(d).append(f),d},createBrowserContext:function(){var a={};return DTFINDER.config.permissions.create&&(a["new-folder"]="New Folder…"),a.properties="Properties",this.createContextMenu("bro-context-menu",a)},createItemContext:function(){var a={};return DTFINDER.config.permissions.move&&(a.rename="Rename",a.move="Move…"),DTFINDER.config.permissions["delete"]&&(a["delete"]="Delete…"),a.properties="Properties",this.createContextMenu("item-context-menu",a)},createContextMenu:function(a,b){var c=this.create("UL",{role:"menu"}).addClass("dropdown-menu");$.each(b,$.proxy(function(a,b){li=this.createContextAction(a,b),$(c).append(li)},this));var d=this.create("DIV",{id:a}).append(c);return d},createContextAction:function(b,c){return a=this.create("A",{href:"#"}).text(c),li=this.create("LI",{"data-action":b}).append(a),li},createNode:function(a,b){var c=this.create("I").addClass(DTFINDER.config.classes.collapse);a="/"===a?"":a;var d=this.create("A",{href:"#/"+a}).addClass("dtf-tree-node").append(" "+b),e=this.create("A",{href:"#"}).addClass("toggler").append(c),f=this.create("LI").append(e).append(d);return f},createFileItem:function(a){var b=this.create("LI").addClass("dtf-file-item dtf-context-holder");if(b.data("context-target","#item-context-menu"),"image"==a.type){var c=this.create("IMG",{src:a.base64}).addClass("icon");$(b).addClass("img-item")}else{if("file"==a.type){var d="fa fa-file-o";$(b).addClass("file-item")}else if("dir"==a.type){var d="fa fa-folder-o";$(b).addClass("folder-item")}else var d=null;var c=this.create("I").addClass("icon").addClass(d)}var e=this.create("A",{href:a.path}).append(c).append('<div style="overflow: hidden;text-overflow: ellipsis;" class="file-name">'+a.label+"</div>");return $(b).append(e),b}},DTFINDER.File={url:null,data:{},list:function(a){var b,c=$.extend({op:"ls",path:a},this.data);return $.ajax({url:this.url,data:c,async:!1}).done(function(a){b=a}),b},move:function(a,b){var c=$.extend({op:"move",path:a,dest:b},this.data);$.ajax({url:this.url,type:"POST",data:c,async:!1})},rename:function(a,b){var c=$.extend({op:"rename",path:a,newName:b},this.data);$.ajax({url:this.url,type:"POST",data:c,async:!1})},"delete":function(a){var b,c=$.extend({op:"delete",path:a},this.data);return $.ajax({url:this.url,data:c,async:!1}).done(function(a){b=a}),b},properties:function(a){var b,c=$.extend({op:"properties",path:a},this.data);return $.ajax({url:this.url,data:c,async:!1}).done(function(a){b=a}),b},search:function(a,b){var c,d=$.extend({op:"search",path:b,q:a},this.data);return $.ajax({url:this.url,data:d,async:!1}).done(function(a){c=a}),c}},function(a,b,c,d){function e(b,c){this.element=b,this.options=d.config=a.extend({},g,c),this.options.data=d.config.data=a.extend({},g.data,c.data),this.options.classes=d.config.classes=a.extend({},g.classes,c.classes),this.options.permissions=d.config.permissions=a.extend({},g.permissions,c.permissions),this._defaults=g,this._name=f,this.init()}var f="finder",g={url:null,manage:!0,upload:!0,uploadUrl:null,width:"100%",height:600,onSelect:!1,classes:{collapse:"fa fa-folder-o",expand:"fa fa-folder-open-o"},permissions:{create:!0,"delete":!0,move:!0},data:{}};e.prototype={init:function(){this._caches={},this._caches.loaded=[],this._caches.data=[],d.File.url=this.options.url,d.File.data=this.options.data,this.createElements(this.element,this.options),this.initTree(),this.listen(this.element,this.options),this.openRoot()},initTree:function(){var b=[{path:"/",label:"/",type:"dir"}],c=this.buildList(b);this.nav.append(c);var d=this;a(this.nav).on("click","a.toggler",function(b){b.preventDefault();var c=a(this).siblings(".dtf-tree-node");a(this).children("i").hasClass(d.options.classes.expand)?d.collapse(c):d.expand(c),d.handleHight()})},openRoot:function(){var c=b.location.hash.substr(1);if(c)for(var d=c.split("/"),e="",f="/";0!==d.length;){e=e+d.shift()+"/",e.trim(),"/"!=e&&(f=e.substr(0,e.length-1));var g=a('a[href="#'+f+'"]');this.expand(g)}else{c="/",b.location.hash="/";var g=a('a[href="#'+c+'"]');this.expand(g)}this.open(c)},listen:function(c,d){var e=this;b.onpopstate=function(){var a=b.location.hash.substr(1);e.open(a)},a("#sub-browser-dialog").on("click","a.toggler",function(b){b.preventDefault();var c=a(this).siblings(".dtf-tree-node");a(this).children("i").hasClass(e.options.classes.expand)?e.collapse(c):e.expand(c)}),a("#sub-browser-dialog").on("click","a.dtf-tree-node",function(b){b.preventDefault();var c=b.currentTarget;a("#sub-browser-dialog").find(".selected").removeClass("selected"),a(c).addClass("selected")}),d.manage&&this.listenContextMenu(c),this.listenUpload(this._caches.currentPath),this.listenCreateFolder(this._caches.currentPath),this.listenRename(),this.listenSearch(),a(c).on("click",".dtf-file-item a",function(a){a.preventDefault()}),a(c).on("click",".img-item a",function(b){b.preventDefault(),a.isFunction(d.onISelect)&&d.onISelect(b)})},open:function(b){if(this._caches.currentPath=b,-1===a.inArray(b,this._caches.loaded)){var c=d.File.list(b);this._caches.data[b]=c,this._caches.loaded.push(b)}this.listenUpload(b),this.listenCreateFolder(b),this.updateBrowser(this._caches.data[b]),this.handleHight()},listenSearch:function(){var b=this;a(c).on("keyup",".dt-search-input",function(){var c=a(this).val();if(c.length>1){var e=b._caches.currentPath,f=d.File.search(c,e);b.updateBrowser(f)}})},listenRename:function(){var b=13,e=27,f=this;a(c).on("keyup",".dt-rename-input",function(c){if((c.keyCode==e||c.which==e)&&(a(c.target).parent().siblings("a").children(".file-name").show(),a(c.target).parent().remove()),c.keyCode==b||c.which==b){var g=a(this).data("path"),h=a(this).val();d.File.rename(g,h),a(c.target).parent().siblings("a").children(".file-name").text(h).show(),a(c.target).parent().remove(),f.refresh()}}),a(c).on("blur",".dt-rename-input",function(b){a(b.target).parent().siblings("a").children(".file-name").show(),a(b.target).parent().remove()})},listenContextMenu:function(b){a(b).contextmenu({onItem:a.proxy(this.handleContext,this),before:function(c){var d=null;if(a(c.target).hasClass("dtf-context-holder"))a(b).data("context-holder",c.target),d=a(c.target).data("context-target");else{var e=a(c.target).parents();a.each(e,function(c,e){return a(e).hasClass("dtf-context-holder")?(a(b).data("context-holder",e),d=a(e).data("context-target"),!1):void 0})}return null===d?!1:(a(b).data("target",d),!0)}})},listenUpload:function(b){var c=a.extend({path:b,op:"upload"},this.options.data);a("#upload-form").ajaxForm({data:c,success:a.proxy(function(c){for(this.refresh(b),i=0;i<c.length;i++)a(".uploaded").append("<p> New file: "+c[i].uploaded+"</p>")},this)})},listenCreateFolder:function(b){var c=a.extend({path:b,op:"mkdir"},this.options.data);a("#new-folder-form").ajaxForm({data:c,success:a.proxy(function(c){this.refresh(b),a("#new-folder-dialog").modal("hide"),console.log(c)},this)})},expand:function(b){var c=b.attr("href").substr(1),e=a(b).siblings(".toggler").children("i");if(-1===a.inArray(c,this._caches.loaded)){var f=d.File.list(c);this._caches.data[c]=f,this._caches.loaded.push(c)}var g=this.buildList(this._caches.data[c]);a(b).siblings("ul").remove(),a(g).hide(),a(b).after(g),e.removeClass(this.options.classes.collapse),e.addClass(this.options.classes.expand),a(b).siblings("ul").slideDown("fast")},collapse:function(b){var c=a(b).siblings(".toggler").children("i");c.removeClass(this.options.classes.expand),c.addClass(this.options.classes.collapse),a(b).siblings("ul").slideUp("fast")},handleHight:function(){var b=a(".dtf-area").height();a(".dtf-nav").height(b)},handleContext:function(b,c){c.preventDefault();var e=a(c.target).parent().data("action"),f=a(b).data("context-holder"),g=a(f).children("a").attr("href");switch(e){case"delete":if(!confirm("Are you sure you want to delete "+g+" ?, this cannot be undone."))return!1;var h=d.File["delete"](g);this.refresh(),console.log(h);break;case"rename":var i=a(f).find(".file-name"),j=i.text();i.hide(),a(f).append('<div><input data-path="'+g+'" type="text" style="height:18px;" class="form-control input-sm dt-rename-input" value="'+j+'"></div>'),a(f).find(".dt-rename-input").select();break;case"new-folder":return a("#new-folder-dialog").on("shown.bs.modal",function(){a(".new-folder-input").select()}),void a("#new-folder-dialog").modal("show");case"move":var k=this.buildList([{path:"/",label:"/",type:"dir"}]);a("#sub-browser-dialog").on("shown.bs.modal",function(){a(this).find(".modal-body").html(k),a(this).find(".modal-body").append('<div><button class="btn btn-sm btn-primary folder-selector">Select</button></div>')});var l=this;a("#sub-browser-dialog").on("click",".folder-selector",function(){var b=a("#sub-browser-dialog").find(".selected").attr("href").substr(1);d.File.move(g,b),l.refresh(),a("#sub-browser-dialog").modal("hide")}),a("#sub-browser-dialog").modal("show");break;case"properties":g||(g=this._caches.currentPath);var j=d.File.properties(g),m=["<table>",'<tr><td class="property-label" valign="top" width="70px;">Name</td><td>'+j.Name+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Type</td><td>'+j.Type+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Size</td><td>'+j.Size+"</td></tr>",'<tr><td class="property-label" valign="top" width="70px;">Location</td><td>'+j.Location+"</td></tr>","</table>"].join("");a("#properties-dialog").on("shown.bs.modal",function(){a(this).find(".modal-body").html(m)}),a("#properties-dialog").modal("show")}},updateBrowser:function(b){for(ul=d.DOM.create("UL"),i=0;i<b.length;i++){var c=d.DOM.createFileItem(b[i]);a(ul).append(c)}a(this.browserArea).html(ul)},refresh:function(b){"undefined"==typeof b&&(b=this._caches.currentPath),data=d.File.list("/"+b),this._caches.data[b]=data,this.updateBrowser(data);for(var c=this._caches.loaded.length-1;c--;)this._caches.loaded[c].trim()==b.trim()&&this._caches.loaded.splice(c,1);this._caches.loaded=[];var e=a('a[href="'+b+'"]');e.siblings("ul").remove(),e.children("i").hasClass(this.options.classes.expand)&&(e.click(),e.click())},buildList:function(b){if(b.length>0){var c=d.DOM.create("UL");for(i=0;i<b.length;i++)if("dir"===b[i].type){var e=d.DOM.createNode(b[i].path,b[i].label);a(c).append(e)}return c}return null},createElements:function(b,c){this.nav=d.DOM.create("DIV").addClass("dtf-nav ctn"),this.browserArea=d.DOM.create("DIV").addClass("dtf-area ctn dtf-context-holder"),a(this.browserArea).data("context-target","#bro-context-menu");var e=d.DOM.create("DIV").addClass("row"),f=d.DOM.create("DIV").addClass("wrapper container-fluid"),g=d.DOM.createToolbar(),h=this.options.uploadUrl||this.options.url,i=d.DOM.createUploadDialog(h),j=this.options.createFolderUrl||this.options.url,k=d.DOM.createNewFolderDialog(j),l=d.DOM.createSubBrowserDialog(),m=d.DOM.createPropertiesDialog(),n=d.DOM.createItemContext(),o=d.DOM.createBrowserContext();a(e).append(this.nav).append(this.browserArea),a(f).append(g).append(e),a(b).width(c.width).append(f).after(n).after(o).after(i).after(k).after(l).after(m)}},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document,DTFINDER);